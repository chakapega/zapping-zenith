---
// Callback Popup Component with form
const accessKey = import.meta.env.PUBLIC_WEB3FORMS_ACCESS_KEY;
---

<div class='popup' id='callback-popup' aria-hidden='true' role='dialog' aria-labelledby='popup-title'>
  <div class='popup__overlay' id='popup-overlay'></div>
  <div class='popup__content'>
    <button class='popup__close' id='popup-close' aria-label='Закрыть попап' type='button'>
      <svg width='24' height='24' viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'>
        <path
          d='M18 6L6 18M6 6L18 18'
          stroke='currentColor'
          stroke-width='2'
          stroke-linecap='round'
          stroke-linejoin='round'
        >
        </path>
      </svg>
    </button>
    <h2 class='popup__title' id='popup-title'>Заказать звонок</h2>

    <!-- Success Message -->
    <div class='popup__message popup__message--success' id='success-message' style='display: none;'>
      <svg
        class='popup__message-icon'
        width='48'
        height='48'
        viewBox='0 0 24 24'
        fill='none'
        xmlns='http://www.w3.org/2000/svg'
      >
        <circle cx='12' cy='12' r='10' stroke='currentColor' stroke-width='2'></circle>
        <path d='M8 12l2 2 4-4' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'>
        </path>
      </svg>
      <h3 class='popup__message-title'>Спасибо!</h3>
      <p class='popup__message-text'>Ваше сообщение успешно отправлено. Мы свяжемся с вами в ближайшее время.</p>
      <button type='button' class='popup__submit' id='close-after-success'>Закрыть</button>
    </div>

    <!-- Error Message -->
    <div class='popup__message popup__message--error' id='error-message' style='display: none;'>
      <svg
        class='popup__message-icon'
        width='48'
        height='48'
        viewBox='0 0 24 24'
        fill='none'
        xmlns='http://www.w3.org/2000/svg'
      >
        <circle cx='12' cy='12' r='10' stroke='currentColor' stroke-width='2'></circle>
        <path d='M12 8v4M12 16h.01' stroke='currentColor' stroke-width='2' stroke-linecap='round'></path>
      </svg>
      <h3 class='popup__message-title'>Ошибка</h3>
      <p class='popup__message-text' id='error-text'>
        Произошла ошибка при отправке сообщения. Пожалуйста, попробуйте еще раз.
      </p>
      <button type='button' class='popup__submit' id='retry-after-error'>Попробовать снова</button>
    </div>

    <!-- Form -->
    <form class='popup__form' id='callback-form'>
      <input type='hidden' name='access_key' value={accessKey} />
      <div class='popup__form-group'>
        <label for='callback-name' class='popup__label'>Имя</label>
        <input
          type='text'
          id='callback-name'
          name='name'
          class='popup__input'
          required
          placeholder='Введите ваше имя'
        />
      </div>
      <div class='popup__form-group'>
        <label for='callback-phone' class='popup__label'>Телефон</label>
        <input
          type='tel'
          id='callback-phone'
          name='phone'
          class='popup__input'
          required
          placeholder='+375 (XX) XXX-XX-XX'
        />
      </div>
      <div class='popup__form-group'>
        <label for='callback-email' class='popup__label'>Email</label>
        <input
          type='email'
          id='callback-email'
          name='email'
          class='popup__input'
          required
          placeholder='Введите ваш email'
        />
      </div>
      <div class='popup__form-group'>
        <label for='callback-message' class='popup__label'>Сообщение</label>
        <textarea
          id='callback-message'
          name='message'
          class='popup__textarea'
          required
          rows='4'
          placeholder='Введите ваше сообщение'
        >
        </textarea>
      </div>
      <button type='submit' class='popup__submit' id='submit-button'>
        <span id='submit-text'>Отправить</span>
        <span id='submit-loading' style='display: none;'>Отправка...</span>
      </button>
    </form>
  </div>
</div>

<script>
  const popup = document.getElementById("callback-popup");
  const popupOverlay = document.getElementById("popup-overlay");
  const popupClose = document.getElementById("popup-close");
  const ctaButtons = document.querySelectorAll(".cta-button");

  function openPopup() {
    if (popup) {
      popup.setAttribute("aria-hidden", "false");
      popup.classList.add("popup--open");
      document.body.style.overflow = "hidden";
      // Reset form state when opening
      const formEl = document.getElementById("callback-form");
      const successMsg = document.getElementById("success-message");
      const errorMsg = document.getElementById("error-message");
      const submitBtn = document.getElementById("submit-button");
      const submitTxt = document.getElementById("submit-text");
      const submitLoad = document.getElementById("submit-loading");
      if (formEl) {
        formEl.style.display = "flex";
        (formEl as HTMLFormElement).reset();
      }
      if (successMsg) successMsg.style.display = "none";
      if (errorMsg) errorMsg.style.display = "none";
      if (submitBtn) {
        (submitBtn as HTMLButtonElement).disabled = false;
        if (submitTxt) submitTxt.style.display = "inline";
        if (submitLoad) submitLoad.style.display = "none";
      }
    }
  }

  function closePopup() {
    if (popup) {
      popup.setAttribute("aria-hidden", "true");
      popup.classList.remove("popup--open");
      document.body.style.overflow = "";
    }
  }

  // Open popup on CTA button click
  if (ctaButtons.length) {
    ctaButtons.forEach((ctaButton) => {
      ctaButton.addEventListener("click", (e) => {
        e.preventDefault();
        openPopup();
      });
    });
  }

  // Close popup handlers
  if (popupClose) {
    popupClose.addEventListener("click", closePopup);
  }

  if (popupOverlay) {
    popupOverlay.addEventListener("click", closePopup);
  }

  // Close on Escape key
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && popup?.classList.contains("popup--open")) {
      closePopup();
    }
  });

  // Handle form submission
  const form = document.getElementById("callback-form");
  const successMessage = document.getElementById("success-message");
  const errorMessage = document.getElementById("error-message");
  const errorText = document.getElementById("error-text");
  const submitButton = document.getElementById("submit-button");
  const submitText = document.getElementById("submit-text");
  const submitLoading = document.getElementById("submit-loading");
  const closeAfterSuccess = document.getElementById("close-after-success");
  const retryAfterError = document.getElementById("retry-after-error");

  function showForm() {
    if (form) form.style.display = "flex";
    if (successMessage) successMessage.style.display = "none";
    if (errorMessage) errorMessage.style.display = "none";
  }

  function showSuccess() {
    if (form) form.style.display = "none";
    if (successMessage) successMessage.style.display = "flex";
    if (errorMessage) errorMessage.style.display = "none";
  }

  function showError(message: string) {
    if (form) form.style.display = "none";
    if (successMessage) successMessage.style.display = "none";
    if (errorMessage) errorMessage.style.display = "flex";
    if (errorText)
      errorText.textContent = message || "Произошла ошибка при отправке сообщения. Пожалуйста, попробуйте еще раз.";
  }

  function setLoading(loading: boolean) {
    if (submitButton) {
      (submitButton as HTMLButtonElement).disabled = loading;
      if (submitText) submitText.style.display = loading ? "none" : "inline";
      if (submitLoading) submitLoading.style.display = loading ? "inline" : "none";
    }
  }

  if (form) {
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      setLoading(true);

      const formData = new FormData(form as HTMLFormElement);

      try {
        const response = await fetch("https://api.web3forms.com/submit", {
          method: "POST",
          body: formData,
        });

        const data = await response.json();

        if (response.ok && data.success) {
          showSuccess();
          (form as HTMLFormElement).reset();
        } else {
          showError(data.message || "Не удалось отправить сообщение. Пожалуйста, попробуйте позже.");
        }
      } catch (error) {
        console.error("Form submission error:", error);
        showError("Ошибка сети. Пожалуйста, проверьте подключение к интернету и попробуйте снова.");
      } finally {
        setLoading(false);
      }
    });
  }

  if (closeAfterSuccess) {
    closeAfterSuccess.addEventListener("click", () => {
      showForm();
      closePopup();
    });
  }

  if (retryAfterError) {
    retryAfterError.addEventListener("click", () => {
      showForm();
    });
  }
</script>

<style>
  .popup {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    visibility: hidden;
    transition:
      opacity 0.3s ease,
      visibility 0.3s ease;
  }

  .popup--open {
    opacity: 1;
    visibility: visible;
  }

  .popup__overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
  }

  .popup__content {
    position: relative;
    background-color: #ffffff;
    border-radius: 12px;
    padding: 32px;
    max-width: 500px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    transform: scale(0.9);
    transition: transform 0.3s ease;
    z-index: 10001;
  }

  .popup--open .popup__content {
    transform: scale(1);
  }

  .popup__close {
    position: absolute;
    top: 16px;
    right: 16px;
    background: none;
    border: none;
    cursor: pointer;
    padding: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #666;
    transition: color 0.2s ease;
    z-index: 1;
  }

  .popup__close:hover {
    color: #1a73e8;
  }

  .popup__title {
    margin: 0 0 24px 0;
    font-size: 24px;
    font-weight: 700;
    color: #1a73e8;
  }

  .popup__form {
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  .popup__form-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .popup__label {
    font-size: 14px;
    font-weight: 600;
    color: #333;
  }

  .popup__input,
  .popup__textarea {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    font-size: 16px;
    font-family: inherit;
    transition: border-color 0.2s ease;
    box-sizing: border-box;
  }

  .popup__input:focus,
  .popup__textarea:focus {
    outline: none;
    border-color: #1a73e8;
  }

  .popup__textarea {
    resize: vertical;
    min-height: 100px;
  }

  .popup__submit {
    background-color: #1a73e8;
    color: #ffffff;
    border: none;
    border-radius: 8px;
    padding: 14px 24px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition:
      background-color 0.2s ease,
      transform 0.1s ease;
    font-family: inherit;
    margin-top: 8px;
  }

  .popup__submit:hover {
    background-color: #1557b0;
  }

  .popup__submit:active {
    transform: scale(0.98);
  }

  .popup__submit:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .popup__message {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    gap: 16px;
  }

  .popup__message-icon {
    color: #1a73e8;
    margin-bottom: 8px;
  }

  .popup__message--error .popup__message-icon {
    color: #d32f2f;
  }

  .popup__message-title {
    margin: 0;
    font-size: 22px;
    font-weight: 700;
    color: #1a73e8;
  }

  .popup__message--error .popup__message-title {
    color: #d32f2f;
  }

  .popup__message-text {
    margin: 0;
    font-size: 16px;
    color: #666;
    line-height: 1.5;
  }

  @media screen and (max-width: 768px) {
    .popup__content {
      padding: 24px;
      width: 95%;
    }

    .popup__title {
      font-size: 20px;
      margin-bottom: 20px;
    }
  }
</style>
