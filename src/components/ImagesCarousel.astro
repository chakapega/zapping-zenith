---
import { Image } from "astro:assets";
import type { ImageMetadata } from "astro";

import SectionHeader from "./SectionHeader.astro";

export interface Props {
  title: string;
  subtitle: string;
  elements: CarouselElement[];
}

export interface CarouselElement {
  image: ImageMetadata;
  description: string;
}

const { title, subtitle, elements } = Astro.props;
---

<section class='images-carousel'>
  <div class='images-carousel__header'>
    <div class='images-carousel__title-wrapper'>
      <SectionHeader
        title={title}
        subtitle={subtitle}
      />
    </div>
    <div class='images-carousel__controls'>
      <button
        class='images-carousel__nav-button images-carousel__nav-button--prev'
        aria-label='Предыдущий проект'
        type="button"
      >
        <svg width='24' height='24' viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'>
          <path
            d='M15 18L9 12L15 6'
            stroke='currentColor'
            stroke-width='2'
            stroke-linecap='round'
            stroke-linejoin='round'
          >
          </path>
        </svg>
      </button>
      <button
        class='images-carousel__nav-button images-carousel__nav-button--next'
        aria-label='Следующий проект'
        type="button"
      >
        <svg width='24' height='24' viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'>
          <path
            d='M9 18L15 12L9 6'
            stroke='currentColor'
            stroke-width='2'
            stroke-linecap='round'
            stroke-linejoin='round'
          >
          </path>
        </svg>
      </button>
    </div>
  </div>

  <div class='images-carousel__carousel-wrapper'>
    <div class='images-carousel__carousel'>
      {
        elements.map((element) => (
          <div class='images-carousel__card'>
            <div class='images-carousel__card-image'>
              <Image src={element.image} alt={element.description} loading='lazy' />
            </div>
          </div>
        ))
      }
    </div>
  </div>
</section>

<style>
  .images-carousel {
    padding-top: 60px;
    background-color: var(--hover-white-btn);
  }

  .images-carousel__header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin: 0 auto;
    gap: 20px;
    max-width: 1200px;
  }

  .images-carousel__title-wrapper {
    flex: 1;
  }

  .images-carousel__controls {
    display: flex;
    gap: 12px;
    flex-shrink: 0;
  }

  .images-carousel__nav-button {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background-color: var(--primary-color);
    color: var(--white);
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition:
      background-color 0.2s ease,
      transform 0.1s ease;
    flex-shrink: 0;
  }

  .images-carousel__nav-button:hover {
    background-color: #2980b9;
  }

  .images-carousel__nav-button:active {
    transform: scale(0.95);
  }

  .images-carousel__nav-button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .images-carousel__nav-button svg {
    width: 24px;
    height: 24px;
  }

  .images-carousel__carousel-wrapper {
    overflow: hidden;
    position: relative;
  }

  .images-carousel__carousel {
    display: flex;
    gap: 24px;
    overflow-x: auto;
    scroll-behavior: smooth;
    scrollbar-width: none;
    -ms-overflow-style: none;
    padding: 40px 0 60px 0;
  }

  .images-carousel__carousel::-webkit-scrollbar {
    display: none;
  }

  .images-carousel__card {
    flex: 0 0 420px;
    background-color: var(--white);
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    transition:
      box-shadow 0.3s ease,
      transform 0.2s ease;
    display: flex;
    flex-direction: column;
  }

  .images-carousel__card:first-child {
    margin-left: 20px;
  }

  .images-carousel__card:last-child {
    margin-right: 20px;
  }

  .images-carousel__card:hover {
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
    transform: scale(1.01);
  }

  .images-carousel__card-image {
    width: 100%;
    height: 280px;
    overflow: hidden;
    background-color: #e0e0e0;
  }

  .images-carousel__card-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  @media screen and (max-width: 1024px) {
    .images-carousel {
      padding-top: 40px;
    }

    .images-carousel__header {
      flex-direction: column;
      padding: 0 20px 0 20px;
    }

    .images-carousel__controls {
      align-self: flex-end;
    }

    .images-carousel__card {
      flex: 0 0 320px;
    }

    .images-carousel__card-image {
      height: 240px;
    }
  }
</style>

<script>
  const initCarousels = () => {
    document.querySelectorAll(".images-carousel").forEach((section) => {
      const carousel = section.querySelector(".images-carousel__carousel");
      const prevButton = section.querySelector(".images-carousel__nav-button--prev");
      const nextButton = section.querySelector(".images-carousel__nav-button--next");

      if (!carousel || !prevButton || !nextButton) return;

      const updateButtons = () => {
        const { scrollLeft, scrollWidth, clientWidth } = carousel as HTMLElement;
        const isAtStart = scrollLeft <= 0;
        const isAtEnd = scrollLeft >= scrollWidth - clientWidth - 10;

        (prevButton as HTMLButtonElement).disabled = isAtStart;
        (nextButton as HTMLButtonElement).disabled = isAtEnd;
      };

      const scrollCarousel = (direction: "prev" | "next") => {
        const cardWidth =
          (carousel as HTMLElement).querySelector(".images-carousel__card")?.clientWidth || 380;
        const scrollAmount = cardWidth;

        if (direction === "prev") {
          (carousel as HTMLElement).scrollBy({ left: -scrollAmount, behavior: "smooth" });
        } else {
          (carousel as HTMLElement).scrollBy({ left: scrollAmount, behavior: "smooth" });
        }
      };

      prevButton.addEventListener("click", () => scrollCarousel("prev"));
      nextButton.addEventListener("click", () => scrollCarousel("next"));

      carousel.addEventListener("scroll", updateButtons);
      window.addEventListener("resize", updateButtons);

      updateButtons();
    });
  };

  initCarousels();
  document.addEventListener("astro:after-swap", initCarousels);
</script>
